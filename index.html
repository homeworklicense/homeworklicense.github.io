<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Homework License</title>
    <style>
        #year, #licenser {
            background-color: lightgray;
        }
    </style>
</head>

<body>
<header>
    <h1>The Homework License</h1>

    <div id="links">
        <div id="share" onclick="share(this)">Share your license</div>
        <div id="gh">GitHub</div>
    </div>
</header>
<main>
    <p id="subtitle">
        Copyright
        <input id="year" value="2020" type="number">
        <input id="licenser" spellcheck="false" value="Jakub Koralewski">
    </p>

    <p>
        Permission is hereby granted, free of charge, to any person obtaining a copy of this homework and associated
        files (the "Homework"), to deal in the Homework without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Homework, and to
        permit persons to whom the Homework is furnished to do so, subject to the following conditions:
    </p>
    <p>
        The above copyright notice and this permission notice shall be included in all copies or substantial
        portions of the Homework.
    </p>
    <p>
        THE HOMEWORK IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT
        LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO
        EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
        AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE HOMEWORK OR THE USE
        OR OTHER DEALINGS IN THE HOMEWORK.
    </p>
</main>
<footer>
    The Homework License is provided "as is", without warranty... etc.
    Please consult your lawyer before using this license.
</footer>
</body>
<script>
</script>
<script>
    //@ts-check
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const p = urlParams.get('p');

    const STATE = {year: {i: 1}, licenser: {i: 0}, option: {i:2, data:0}, i: 0, on: true};
    const shareButton = document.querySelector("#share");
    const encodeURL = () => encodeURI(
        `${window.location.origin}/${STATE.licenser.data}/${STATE.year.data}/${STATE.option.data}`
    );

    /* elem.data -> URL */
    function setURL() {
        console.log("set url in", this);
        const paths = window.location.pathname.split("/");
        if (this.element) {
            this.data = this.element.value;
        }
        paths[STATE.i + this.i] = this.data;
        window.history.replaceState(null, "", window.location.origin + paths.join("/"));
        if (shareButton.isShareText) {
            shareButton.textContent = encodeURL();
        }
    }

    /* URL -> elem.data */
    function getURL() {
        console.log("get url in", this);
        this.element.value = this.data;
    }

    STATE.year.setURL =     setURL.bind(STATE.year);
    STATE.licenser.setURL = setURL.bind(STATE.licenser);
    STATE.option.setURL =   setURL.bind(STATE.option);

    STATE.year.getURL =     getURL.bind(STATE.year);
    STATE.licenser.getURL = getURL.bind(STATE.licenser);

    if (p != null) {
        window.location.href = window.location.origin + p;
        STATE.on = false;
    } else {
        const path = window.location.pathname;
        console.log("path: ", path);
        const paths = path.split("/");

        if (paths[0].trim() === "") STATE.i = 1;

        if (paths.length - STATE.i !== 3) {
            console.warn("incorrect number of arguments in ", paths);
            STATE.on = false;
        } else {
            STATE.licenser.data = decodeURI(paths[STATE.i + STATE.licenser.i].trim());
            STATE.year.data = paths[STATE.i + STATE.year.i];
            STATE.option.data = parseInt(paths[STATE.i + STATE.option.i]);
            console.log("STATE", STATE);
        }
    }

    const subtitle = document.querySelector("#subtitle");

    STATE.year.element = subtitle.querySelector("#year");
    STATE.licenser.element = subtitle.querySelector("#licenser");

    if (STATE.on) {
        // Has properties in URL
        for (const elem of [STATE.year, STATE.licenser]) {
            elem.getURL();
            elem.element.addEventListener("input", elem.setURL);
        }
    } else {
        // Empty properties in URL.
        // Requires being bound to itself for some reason for `this` to work.
        function offFunc(elem) {
            // Create function that will set URL of each elem
            // despite even only one being written to.
            return () => {
                [STATE.year, STATE.licenser, STATE.option].forEach(x => x.setURL());
                if (!STATE.on) {
                    // Remove this function, and add.
                    console.log("elem", elem);
                    console.log("this", this);
                    elem.element.removeEventListener("input", this);
                    elem.element.addEventListener("input", elem.setURL);
                }
            }
        }

        for (const elem of [STATE.year, STATE.licenser]) {
            elem.data = elem.element.value;
            elem.element.addEventListener("input", offFunc.bind(offFunc)(elem));
        }
    }

    function share(shareButton) {
        console.log("Share", shareButton);
        if (shareButton.isShareText === true) {
            shareButton.textContent = shareButton.dataset.text;
            shareButton.isShareText = false;
        } else {
            shareButton.dataset.text = shareButton.textContent;
            shareButton.textContent = encodeURL();
            shareButton.isShareText = true;
        }
    }

</script>
</html>